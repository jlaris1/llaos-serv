extends ../../layouts/layout.jade
block contenido 
    style.
        a.btn-success {
            border: 0;
            border-radius: 2px;
        }

        select option:selected{
            background-color:#FFF !important
        }
    script.
        var modu_select = [];
        var autorizador = false;

        $(document).ready( function(){
            $('#spanMenuSistemas').removeClass('fa-angle-left');
            $('#spanMenuSistemas').addClass('fa-angle-down');
            $('#subMenuSistemas').removeClass('hidden');
            $('#subMenuUsuarios').removeClass('hidden');
            $('#spanMenuUsuarios').removeClass('fa-angle-left');
            $('#spanMenuUsuarios').addClass('fa-angle-down'); 

            if($('#chk').text() == 'true'){
                $('#chkAutorizar').prop('checked', true);
            } else {
                $('#chkAutorizar').prop('checked', false);
            } 

            $('#chkAutorizar').checkboxpicker({
                offLabel: 'No',
                onLabel: 'Si'
            }); 

            $('#chkMostrar').checkboxpicker({
                offLabel: 'No',
                onLabel: 'Si'
            }); 
            
            $("#chkMostrar").change(function(){
                if($(this).prop("checked") == true){
                    $('#conformato').addClass('hidden');
                    $('#sinformato').removeClass('hidden');
                }else{
                    $('#sinformato').addClass('hidden');
                    $('#conformato').removeClass('hidden');
                }
            });       
            
            $("#chkAutorizar").change(function(){
                if($(this).prop("checked") == true){
                    autorizador = true;
                }else{
                    autorizador = false;
                }
            });  

            obtenerAreas();
        });

        function actualizar(){
            $.post( "/usuarios/editar/usuario/" + $('#id_user').val(), {
                nombre: $("input[name=nombre]").val(),
                correo: $("input[name=correo]").val(),
                usuario: $("input[name=usuario]").val(),
                password: $("input[name=password]").val(),
                nacimiento: $("input[name=nacimiento]").val(),
                numero_nomina: $("input[name=numero_nomina]").val(),
                empresa: $("select[name=empresa]").val(),
                unidad_negocio: $("select[name=unidad_negocio]").val(),
                permisos: $("select[name=permisos]").val(),
                autorizador: autorizador,
                area: $("select[name=area]").val(),
                modulo: $("select[name=modulo]").val()

            }, (data, status) => {
                //console.log(data);
                //console.log(status);
                
                // Mostrar notificación de guardado correcto 
                $('#alert').removeClass('alert-warning');
                $('#alert').addClass('alert-success');
                $('#alertDiv').removeClass('hidden');
                $('#msg1').text('Se ha guardado ');
                $('#msg2').text('el nuevo usuario.');
                $('#msg_alert').text('éxito ');
                $('#guardar').addClass('disabled');
                $('#guardar').attr('link', '');
            }, "json");
        }

        function obtenerModulos(){
            if ($('#areas').val() == "5e4eceea3b139a5224a9ee5a" || $("#areas").val() == "5e4ecf2c3b139a5224a9ee5b"){
                    $('#h_modulo').removeClass('hidden');
                    $('#modulosSal').removeClass('hidden');
                    $('#sel').removeClass('hidden');
                    $('#a').removeClass('hidden');
                    $('#b').removeClass('hidden');
                    $('#ac').addClass('hidden');
                    $('#bc').addClass('hidden');
                    $('#d').addClass('hidden');
                    $('#e').addClass('hidden');
                    $('#reser').removeClass('hidden');
                    $('#module').attr('required', true);
                    seleccionarModulos();
                } else {
                    $('#h_modulo').addClass('hidden');
                    $('#piscinas').addClass('hidden');
                    $('#modulos').addClass('hidden');
                    $('#module').attr('required', false);
                }
        }

        function obtenerModuloSeleccionado(seleccionado){
            if (seleccionado == "5e4eceea3b139a5224a9ee5a" || seleccionado == "5e4ecf2c3b139a5224a9ee5b"){
                    $('#h_modulo').removeClass('hidden');
                    $('#modulosSal').removeClass('hidden');
                    $('#sel').removeClass('hidden');
                    $('#a').removeClass('hidden');
                    $('#b').removeClass('hidden');
                    $('#ac').addClass('hidden');
                    $('#bc').addClass('hidden');
                    $('#d').addClass('hidden');
                    $('#e').addClass('hidden');
                    $('#reser').removeClass('hidden');
                    $('#module').attr('required', true);
                    seleccionarModulos();
                } else {
                    $('#h_modulo').addClass('hidden');
                    $('#piscinas').addClass('hidden');
                    $('#modulos').addClass('hidden');
                    $('#module').attr('required', false);
                }
        }

        function seleccionarModulos(){
            modu_select = $('#modulos_selec').val().split(",");

            for(let i = 0; i <= modu_select.length -1; i++){               
                if($('#opt'+modu_select[i]).val() == modu_select[i]){
                    $('#opt'+modu_select[i]).attr('selected', true);
                }
            }
        }

        function obtenerAreas(){
            var seleccionado = $('#id_area').val();

            $.getJSON('/usuarios/find/' + $('#cmbUnidadNeg').val(), (datos)=>{
                console.log(datos)
                 if( datos.modulos.length > 0){
                    $('#moduloS')
                        .empty();
                    
                    for(var i = 0; i < datos.modulos.length; i ++){
                        $("#moduloS")
                            .append($("<option id=opt"+datos.modulos[i]._id+"></option>")
                            .attr("value",datos.modulos[i]._id)
                            .text(datos.modulos[i].nombre));
                    }
                }

                if( datos.areas.length > 0){
                    $('#areas')
                        .empty()
                        .append('<option value=-1> << Seleccione >> </option>');
                        
                    for(var i = 0; i < datos.areas.length; i ++){
                        if(datos.areas[i]._id == seleccionado){
                            $("#areas")
                            .append($("<option></option>")
                            .attr("value", datos.areas[i]._id)
                            .attr("selected", true)
                            .text(datos.areas[i].codigo + " - "+ datos.areas[i].nombre));
                        } else {
                            $("#areas")
                            .append($("<option></option>")
                            .attr("value",datos.areas[i]._id)
                            .text(datos.areas[i].codigo + " - "+ datos.areas[i].nombre));
                        }

                        if(i == datos.areas.length -1){
                            obtenerModuloSeleccionado(seleccionado);
                        }
                    }
                }             
            });
        }
    //Termina Javascript
    
    //  Título
    section.mb-4
        .card
            .card-body.d-flex.justify-content-between
                h4.h4-responsive.mt-3
                    i.fas.fa-user-edit
                    |   Actualizar datos usuario
                div
                    a#guardar(href="javascript:actualizar();").btn.btn-success.Ripple-parent.green-gradient
                        i(style="color: white;" data-toggle="tooltip", data-placement="top", title="Realizar").fas.fa-save
    
    // Datos usuario
    section.mb-4
        .card
            .card-body
                input#id_user(type="text" value="#{usr.id}").hidden
                div.d-flex.justify-content-between
                    .col-lg-12.col-md-12.col-sm-12.col-xs-12
                        .form-group
                            label | Nombre
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-user-circle(style="color: #fff;")
                                input.form-control(required type="text" name="nombre" value="#{usr.nombre}" placeholder="Nombre" tabindex="1")
                div.d-flex.justify-content-between
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4
                        .form-group
                            label | Usuario
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-user(style="color: #fff;")
                                input.form-control(required type="text" name="usuario" value="#{usr.usuario}" placeholder="Usuario" tabindex="2")
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4
                        .form-group
                            label | Password
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-asterisk(style="color: #fff;")
                                input#conformato.form-control(required type="password" name="password" value="#{usr.password}" placeholder="Password" tabindex="3")
                                input#sinformato.form-control.hidden(required type="text" name="password" value="#{usr.password}" placeholder="Password" tabindex="3")
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4(style="margin-top: 25px;")
                        .form-check
                            input#chkMostrar(type="checkbox")
                            label(style="margin-left: 15px;")
                                |   ¿Mostrar password?
                div.d-flex.justify-content-between
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6
                        .form-group
                            label | Permisos
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-building(style="color: #fff;")
                                select.form-control(required id="cmbPermisos" name="permisos" tabindex="4")
                                    option(value=-1) << Seleccione >>
                                    option(value="usuario", selected=('usuario'== usr.permisos)) usuario
                                    option(value="compras", selected=('compras'== usr.permisos)) compras
                                    option(value="admin", selected=('admin'== usr.permisos)) admin
                                    option(value="almacen_camaron", selected=('almacen_camaron'== usr.permisos)) Almacen camarón
                                    option(value="gerente_modulo", selected=('gerente_modulo'== usr.permisos)) Gerente módulo
                                    option(value="owner", selected=('owner'== usr.permisos)) owner
                                    option(value="master", selected=('master'== usr.permisos)) master
                                    option(value="externo", selected=('externo'== usr.permisos)) externo
                                    option(value="developer", selected=('developer'== usr.permisos)) developer
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6(style="margin-top: 25px;")
                        label#chk.hidden #{usr.autorizador}
                        .form-check
                            input#chkAutorizar(type="checkbox" name="autoriza" tabindex="5")
                            label(style="margin-left: 15px;")
                                |   ¿El usuario podrá autorizar requisiciones?
                div.d-flex.justify-content-between
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6
                        .form-group
                            label | Fecha Nacimiento
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-calendar(style="color: #fff;")
                                input#nacimiento.form-control(required type="date" name="nacimiento" value="#{usr.nacimiento}" tabindex="6")
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6
                        .form-group
                            label | Correo
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-envelope(style="color: #fff;")
                                input.form-control(required type="mail" name="correo" value="#{usr.correo}" placeholder="Correo" tabindex="7")
                div.d-flex.justify-content-between
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4
                        .form-group
                            label | Número Nómina
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-hashtag(style="color: #fff;")
                                input.form-control(required type="number" step="1" min="0" name="numero_nomina" value="#{usr.numero_nomina}" placeholder="Número nómina" tabindex="8")
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4
                        .form-group
                            label | Unidad de Negocios
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-asterisk(style="color: #fff;")
                                select.form-control(required id="cmbUnidadNeg" name="unidad_negocio" tabindex="9" onchange="obtenerAreas()")
                                    option(value="") << Seleccione >>
                                    each unidad in unidades_negocios
                                        option(value = unidad.id, selected=(unidad.id == usr.unidad_negocio)) #{ unidad.nombre }
                    .col-lg-4.col-md-4.col-sm-4.col-xs-4
                        .form-group
                            label | Empresa
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-building(style="color: #fff;")
                                select.form-control(required id="cmbEmpresa" name="empresa" tabindex="10")
                                    option(value=-1) << Seleccione >>
                                    option(value="Llaos Acuacultura S.A. de C.V.", selected=('Llaos Acuacultura S.A. de C.V.'== usr.empresa)) Llaos Acuacultura S.A. de C.V.
                                    option(value="Renegados", selected=('Renegados'== usr.empresa)) Renegados
                                    option(value="Crap", selected=('Crap'== usr.empresa)) Crap
                                    option(value="Anclar", selected=('Anclar'== usr.empresa)) Anclar
                .d-flex.justify-content-between
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6
                        input.hidden#id_area(type="text" value="#{usr.area}")
                        .form-group
                            label | Área
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-map-signs.fa-input(style="color: #fff;")
                                select#areas.form-control(tabindex="2" name="area" onchange="obtenerModulos()")
                    .col-lg-6.col-md-6.col-sm-6.col-xs-6#modulosSal.hidden
                        input.hidden#modulos_selec(type="text" value="#{usr.modulo}")
                        .form-group
                            label | Modulo
                            .input-group
                                span.input-group-addon.blue-gradient
                                    i.fas.fa-input.fa-map-pin(style="color: #fff;")
                                select#moduloS.form-control(tabindex="3" name="modulo" multiple)
                                    each modulo in modulos
                                        